from flask import Flask, jsonify, request, send_fileimport jsonfrom datetime import datetimeimport matplotlib.pyplot as pltfrom jobs import rd, add_job,return_job, return_image,rdsfrom funcs import get_stock_diffapp = Flask(__name__)stock_tickers = [ticker.decode('utf-8') for ticker in rds.keys()]    @app.route('/', methods=['GET'])def instructions():    return """    Try these routes:        /                 informational    /stock/<ticker>?period=   gives you a graph with a 5 year history    /stock/<ticker>/date gives you the closing price of that particular date    /stock/diff?start=&end= gives you the % change between the dates of the stock    /stock/compare/<ticker1>/<ticker2>?period= compares two stocks with each other        /run              (GET) job instructions    /run              (POST) submit job    /jobs             get list of past jobs    /jobs/<UUID>      get job results    /delete           (GET) delete instructions    /delete           (DELETE) delete job    /download/<UUID>  download img from job """@app.route('/stock/graph', methods=['POST'])def stock_graph():    try:        job = request.get_json(force=True)    except Exception as e:        return True, json.dumps({'status': "Error", 'message': 'Invalid JSON: {}.'.format(e)})        ticker = job['ticker']    if ticker not in stock_tickers:        return 'Please enter a valid ticker', 404        job_type = 'graph'    input_values = {'ticker': ticker}        return add_job(job_type, json.dumps(input_values))    #Date must be in a %Y-%m-%d format@app.route('/stock/<string:ticker>', methods=['GET'])def stock_point(ticker):    if ticker not in stock_tickers:        return 'Please enter a valid ticker', 404        my_stock = json.loads(rds.get(ticker))    date = request.args.get('date')        if date:        if date not in my_stock:            return 'Either you need a date format in %Y-%m-%d or your date is invalid', 404        else:            return jsonify(date + ': ' + str(my_stock[date]))    else:        return jsonify(my_stock)@app.route('/stock/compare', methods=['POST'])def compare_stock():    try:        job = request.get_json(force=True)    except Exception as e:        return True, json.dumps({'status': "Error", 'message': 'Invalid JSON: {}.'.format(e)})    ticker1 = job['ticker1']    ticker2 = job['ticker2']    if ticker1 not in stock_tickers or ticker2 not in stock_tickers:        return 'Please enter a valid ticker', 404    job_type = 'compare'    input_values = {'ticker1': ticker1, 'ticker2': ticker2}        return add_job(job_type, json.dumps(input_values))@app.route('/stock/diff/<string:ticker>/<string:period>', methods=['GET'])def stock_diff(ticker, period):    if ticker not in stock_tickers:        return 'Please enter a valid ticker', 404        stock = json.loads(rds.get(ticker))        try:        result = get_stock_diff(stock, period)        return jsonify(result)    except:        return "Enter a valid period", 404        @app.route('/jobs/<string:uid>', methods=['GET'])def get_job(uid):    return_dict = return_job(uid)    return return_dict@app.route('/download/<string:jobid>', methods=['GET'])def download(jobid):        path = '{}.png'.format(jobid)    with open(path, 'wb') as f:        f.write(return_image(jobid))    return send_file(path, mimetype='image/png', as_attachment=True)if __name__ == '__main__':    app.run(debug=True, host='0.0.0.0')